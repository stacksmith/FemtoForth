cd 'test

PROC deref // (refptr--head/0) find the head for this reference
{ 
    // walk the entire header list.  TOS=header; NOS=addr
    head'bottom begin
      if( dup head'ptr = ) dbl'drop 0 ; thanx  // exit on head'ptr
      if( dbl'dup head'code = ) 
        swap drop ;
      thanx 
      dup head'size +
    again
}
end

PROC deco1 // (ip--ip,e)
{
    U8'@++ // ptr,tok
    if( dup 0= )
      "CODE " ctell ;
    thanx
    4* over table'base + @ // ip,ref
    if( deref dup 0<> )
        ;
    else
        drop 1 error'throw
    thanx
    ;
}
end



PROC deco2 // (ip--ip)
{

    color'dim color'white '<' emit color'reset color'green
    if( error'catch 0= )
        deco1 dup head'name ctell
        head'type push "decompile" pop 
        head'locatex // ip,deco
     dup head'name ctell
        error'clear
    else 
        "ERROR" ctell 
    thanx
    color'dim color'white '>' emit color'reset color'white
    ;
}
end

cd 'system'TYPE'PROC
PROC decompile // (ip--ip)
{
    "PROCTYPE " ctell
}
end

cd 'test

